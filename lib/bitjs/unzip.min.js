importScripts("io.min.js");importScripts("archive.min.js");
var currentFilename="",currentFileNumber=0,currentBytesUnarchivedInFile=0,currentBytesUnarchived=0,totalUncompressedBytesInArchive=0,totalFilesInArchive=0,info=function(b){postMessage(new bitjs.archive.UnarchiveInfoEvent(b))},err=function(b){postMessage(new bitjs.archive.UnarchiveErrorEvent(b))},postProgress=function(){postMessage(new bitjs.archive.UnarchiveProgressEvent(currentFilename,currentFileNumber,currentBytesUnarchivedInFile,currentBytesUnarchived,totalUncompressedBytesInArchive,totalFilesInArchive))},
zLocalFileHeaderSignature=67324752,zArchiveExtraDataSignature=134630224,zCentralFileHeaderSignature=33639248,zDigitalSignatureSignature=84233040,zEndOfCentralDirSignature=101075792,zEndOfCentralDirLocatorSignature=117853008,ZipLocalFile=function(b){if("object"!=typeof b||!b.readNumber||"function"!=typeof b.readNumber)return null;b.readNumber(4);this.version=b.readNumber(2);this.generalPurpose=b.readNumber(2);this.compressionMethod=b.readNumber(2);this.lastModFileTime=b.readNumber(2);this.lastModFileDate=
b.readNumber(2);this.crc32=b.readNumber(4);this.compressedSize=b.readNumber(4);this.uncompressedSize=b.readNumber(4);this.fileNameLength=b.readNumber(2);this.extraFieldLength=b.readNumber(2);this.filename=null;0<this.fileNameLength&&(this.filename=b.readString(this.fileNameLength));info("Zip Local File Header:");info(" version="+this.version);info(" general purpose="+this.generalPurpose);info(" compression method="+this.compressionMethod);info(" last mod file time="+this.lastModFileTime);info(" last mod file date="+
this.lastModFileDate);info(" crc32="+this.crc32);info(" compressed size="+this.compressedSize);info(" uncompressed size="+this.uncompressedSize);info(" file name length="+this.fileNameLength);info(" extra field length="+this.extraFieldLength);info(" filename = '"+this.filename+"'");this.extraField=null;0<this.extraFieldLength&&(this.extraField=b.readString(this.extraFieldLength),info(" extra field="+this.extraField));this.fileData=null;0<this.compressedSize&&(this.fileData=new Uint8Array(b.bytes.buffer,
b.ptr,this.compressedSize),b.ptr+=this.compressedSize);0!=(this.generalPurpose&bitjs.BIT[3])&&(this.crc32=b.readNumber(4),this.compressedSize=b.readNumber(4),this.uncompressedSize=b.readNumber(4))};
ZipLocalFile.prototype.unzip=function(){0==this.compressionMethod?(info("ZIP v"+this.version+", store only: "+this.filename+" ("+this.compressedSize+" bytes)"),currentBytesUnarchivedInFile=this.compressedSize,currentBytesUnarchived+=this.compressedSize):8==this.compressionMethod?(info("ZIP v2.0, DEFLATE: "+this.filename+" ("+this.compressedSize+" bytes)"),this.fileData=inflate(this.fileData,this.uncompressedSize)):(err("UNSUPPORTED VERSION/FORMAT: ZIP v"+this.version+", compression method="+this.compressionMethod+
": "+this.filename+" ("+this.compressedSize+" bytes)"),this.fileData=null)};
var unzip=function(b){postMessage(new bitjs.archive.UnarchiveStartEvent);currentFilename="";currentBytesUnarchived=totalFilesInArchive=totalUncompressedBytesInArchive=currentBytesUnarchived=currentBytesUnarchivedInFile=currentFileNumber=0;var a=new bitjs.io.ByteStream(b);if(a.peekNumber(4)==zLocalFileHeaderSignature){for(b=[];a.peekNumber(4)==zLocalFileHeaderSignature;){var c=new ZipLocalFile(a);c&&(0<c.uncompressedSize&&c.fileData)&&(b.push(c),totalUncompressedBytesInArchive+=c.uncompressedSize)}totalFilesInArchive=
b.length;b.sort(function(a,b){for(var c=a.filename,e=b.filename,g=c.length,l=e.length;"0">c[g-1]||"9"<c[g-1];)--g;for(;"0">e[l-1]||"9"<e[l-1];)--l;for(;"0"<=c[g-1]&&"9">=c[g-1];)--g;for(;"0"<=e[l-1]&&"9">=e[l-1];)--l;c=parseInt(c.substr(g),10);e=parseInt(e.substr(l),10);return c-e});a.peekNumber(4)==zArchiveExtraDataSignature&&(info(" Found an Archive Extra Data Signature"),a.readNumber(4),c=a.readNumber(4),a.readString(c));if(a.peekNumber(4)==zCentralFileHeaderSignature)for(info(" Found a Central File Header");a.peekNumber(4)==
zCentralFileHeaderSignature;){a.readNumber(4);a.readNumber(2);a.readNumber(2);a.readNumber(2);a.readNumber(2);a.readNumber(2);a.readNumber(2);a.readNumber(4);a.readNumber(4);a.readNumber(4);var c=a.readNumber(2),e=a.readNumber(2),g=a.readNumber(2);a.readNumber(2);a.readNumber(2);a.readNumber(4);a.readNumber(4);a.readString(c);a.readString(e);a.readString(g)}a.peekNumber(4)==zDigitalSignatureSignature&&(info(" Found a Digital Signature"),a.readNumber(4),c=a.readNumber(2),a.readString(c));0<b.length&&
postProgress();for(a=0;a<b.length;++a)c=b[a],currentFilename=c.filename,currentFileNumber=a,currentBytesUnarchivedInFile=0,c.unzip(),null!=c.fileData&&(postMessage(new bitjs.archive.UnarchiveExtractEvent(c)),postProgress());postProgress();postMessage(new bitjs.archive.UnarchiveFinishEvent)}};
function getHuffmanCodes(b){if("object"!=typeof b||1>b.length)return err("Error! getHuffmanCodes() called with an invalid array"),null;for(var a=b.length,c=[],e=1,g=0;g<a;++g){var d=b[g];if("number"!=typeof d||0>d)return err("bitLengths contained an invalid number in getHuffmanCodes(): "+d+" of type "+typeof d),null;void 0==c[d]&&(c[d]=0);0<d&&c[d]++;d>e&&(e=d)}for(var g=[],f=0,h=1;h<=e;++h)d=h-1,void 0==c[d]&&(c[d]=0),f=f+c[h-1]<<1,g[h]=f;c={};for(d=e=0;d<a;++d)f=b[d],0!=f&&(c[g[f]]={length:f,symbol:d},
e++,g[f]++);c.maxLength=e;return c}var fixedHCtoLiteral=null,fixedHCtoDistance=null;function getFixedLiteralTable(){if(!fixedHCtoLiteral){for(var b=Array(288),a=0;143>=a;++a)b[a]=8;for(a=144;255>=a;++a)b[a]=9;for(a=256;279>=a;++a)b[a]=7;for(a=280;287>=a;++a)b[a]=8;fixedHCtoLiteral=getHuffmanCodes(b)}return fixedHCtoLiteral}function getFixedDistanceTable(){if(!fixedHCtoDistance){for(var b=Array(32),a=0;32>a;++a)b[a]=5;fixedHCtoDistance=getHuffmanCodes(b)}return fixedHCtoDistance}
function decodeSymbol(b,a){for(var c=0,e=0;;){var g=b.readBits(1),c=c<<1|g;++e;if(a.hasOwnProperty(c)&&a[c].length==e)break;if(e>a.maxLength){err("Bit stream out of sync, didn't find a Huffman Code, length was "+e+" and table only max code length of "+a.maxLength);break}}return a[c].symbol}
var CodeLengthCodeOrder=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],LengthLookupTable=[[0,3],[0,4],[0,5],[0,6],[0,7],[0,8],[0,9],[0,10],[1,11],[1,13],[1,15],[1,17],[2,19],[2,23],[2,27],[2,31],[3,35],[3,43],[3,51],[3,59],[4,67],[4,83],[4,99],[4,115],[5,131],[5,163],[5,195],[5,227],[0,258]],DistLookupTable=[[0,1],[0,2],[0,3],[0,4],[1,5],[1,7],[2,9],[2,13],[3,17],[3,25],[4,33],[4,49],[5,65],[5,97],[6,129],[6,193],[7,257],[7,385],[8,513],[8,769],[9,1025],[9,1537],[10,2049],[10,3073],[11,4097],[11,
6145],[12,8193],[12,12289],[13,16385],[13,24577]];function inflateBlockData(b,a,c,e){for(var g=0,d=0;;){var f=decodeSymbol(b,a);++g;if(256>f)e.insertByte(f),d++;else if(256==f)break;else{var f=LengthLookupTable[f-257],f=f[1]+b.readBits(f[0]),h=DistLookupTable[decodeSymbol(b,c)],k=h[1]+b.readBits(h[0]),h=e.ptr-k,d=d+f;if(f>k)for(k=e.data;f--;)e.insertByte(k[h++]);else e.insertBytes(e.data.subarray(h,h+f))}}return d}
function inflate(b,a){var c=new bitjs.io.BitStream(b.buffer,!1,b.byteOffset,b.byteLength),e=new bitjs.io.ByteBuffer(a),g=0,d=0;do{var f=c.readBits(1),d=c.readBits(2);++g;if(0==d){for(;0!=c.bitPtr;)c.readBits(1);d=c.readBits(16);c.readBits(16);0<d&&e.insertBytes(c.readBytes(d))}else if(1==d)d=inflateBlockData(c,getFixedLiteralTable(),getFixedDistanceTable(),e);else if(2==d){for(var d=c.readBits(5)+257,h=c.readBits(5)+1,k=c.readBits(4)+4,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],l=0;l<k;++l)n[CodeLengthCodeOrder[l]]=
c.readBits(3);n=getHuffmanCodes(n);k=[];for(l=0;k.length<d+h;){var m=decodeSymbol(c,n);if(15>=m)k.push(m),l=m;else if(16==m)for(m=c.readBits(2)+3;m--;)k.push(l);else if(17==m)for(m=c.readBits(3)+3;m--;)k.push(0);else if(18==m)for(m=c.readBits(7)+11;m--;)k.push(0)}d=k.splice(d,h);h=getHuffmanCodes(k);d=getHuffmanCodes(d);d=inflateBlockData(c,h,d,e)}else return err("Error! Encountered deflate block of type 3"),null;currentBytesUnarchivedInFile+=d;currentBytesUnarchived+=d;postProgress()}while(1!=f);
return e.data}onmessage=function(b){unzip(b.data.file,!0)};
